<?php
// $Id$

/**
 * @file
 * E-Center network query interface.
 */

/**
 * Implementation of hook_menu().
 */
function ecenter_weathermap_menu() {
  $items['weathermap'] = array(
    'title' => 'E-Center Weather Map',
    'page callback' => 'ecenter_weathermap',
    //'page arguments' => array(),
    'access arguments' => array('access ecenter weathermap'),
    'type' => MENU_CALLBACK,
  );
  $items['weathermap/data/%/hub-select']  = array(
    'title' => 'E-Center Weather Map',
    'page callback' => 'ecenter_weathermap_ajax',
    'page arguments' => array(2, 3),
    'access arguments' => array('access ecenter weathermap'),
    'file' => 'includes/ecenter_weathermap.ajax.inc',
    'type' => MENU_CALLBACK,
  );
  $items['weathermap/data/%/data']  = array(
    'title' => 'E-Center Weather Map',
    'page callback' => 'ecenter_weathermap_ajax',
    'page arguments' => array(2, 3),
    'access arguments' => array('access ecenter weathermap'),
    'file' => 'includes/ecenter_weathermap.ajax.inc',
    'type' => MENU_CALLBACK,
  );
  $items['admin/settings/ecenter'] = array(
    'title' => 'E-Center Network Query Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ecenter_weathermap_admin_form'),
    'access callback' => 'user_access',
    'access arguments' => array('administer ecenter weathermap'),
    'description' => 'Configure the E-Center weather map.',
    'file' => 'includes/ecenter_weathermap.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implementation of hook_menu().
 */
function ecenter_weathermap_perm() {
  return array('access ecenter weathermap', 'administer ecenter weathermap');
}

/**
 * Implementation of hook_theme().
 */
function ecenter_weathermap_theme() {
  //$options = array('file' => drupal_get_path('module', 'ecenter_weathermap') .'/includes/ecenter_weathermap.theme.inc');
  $path = array(
    'path' => drupal_get_path('module', 'ecenter_weathermap') .'/includes',
    'file' => 'ecenter_weathermap.theme.inc'
  );
  return array(
    'ecenter_weathermap_hop_option' => 
      array('arguments' => array('hop' => NULL)) + $path,
  );
}

/**
 * Primary selection form for weathermap diagnostic UI.
 */
function ecenter_weathermap_select_form($form_state, $services, $src_ip = False, $dst_ip = False, $start = False, $end = False) {
  $quickselect_options = array(
    'emulateDropdown' => TRUE,
    'maxHeight' => '400px',
    'exactMatch' => TRUE,
  );

  $form = array(
    'src_ip' => array(
      '#title'               => t('Source IP'),
      '#type'                => 'quickselect',
      '#options'             => $services,
      '#cols'                => 50,
      '#quickselect_options' => $quickselect_options,
      '#required'            => TRUE,
    ),
    'dst_ip' => array(
      '#title'               => t('Destination IP'),
      '#type'                => 'quickselect',
      '#options'             => $services,
      '#cols'                => 50,
      '#required'            => TRUE,
      '#quickselect_options' => $quickselect_options,
    ),
    'submit' => array(
      '#value' => t('Submit'),
      '#type' => 'submit',
    ),
  );

  return $form;
}

/**
 * Form submission call back for weathermap diagnostic UI.
 */
function ecenter_weathermap_select_form_submit($form, &$form_state) {
  $form_state['redirect'] = array('weathermap', '&src_ip='. $form_state['values']['src_ip'] .'&dst_ip='. $form_state['values']['dst_ip']);
}

/**
 * Page callback for weather map
 */
function ecenter_weathermap() {
  // We need quickselect to get added to behaviors first, so it executes first
  drupal_add_js(drupal_get_path('module', 'quickselect') .'/js/quickselect-behavior.js');
  drupal_add_js(drupal_get_path('module', 'ecenter_weathermap') .'/js/query.js');

  // Add jqPlot
  drupal_add_js(drupal_get_path('module', 'ecenter_weathermap') .'/lib/jqplot/excanvas.min.js');
  drupal_add_js(drupal_get_path('module', 'ecenter_weathermap') .'/lib/jqplot/jquery.jqplot.min.js');

  // jqPlot plugins
  drupal_add_js(drupal_get_path('module', 'ecenter_weathermap') .'/lib/jqplot/plugins/jqplot.dateAxisRenderer.min.js');
  drupal_add_js(drupal_get_path('module', 'ecenter_weathermap') .'/lib/jqplot/plugins/jqplot.highlighter.min.js');
  drupal_add_js(drupal_get_path('module', 'ecenter_weathermap') .'/lib/jqplot/plugins/jqplot.cursor.min.js');

  // Additional CSS overrides
  drupal_add_css(drupal_get_path('module', 'ecenter_weathermap') .'/css/plot.css');

  // Get hubs
  $client = ecenter_weathermap_get_client();
  $hops = $client->getHubs();
  $options = array('' => 'Select a node');
  foreach ($hops['response'] as $hop) {
    $options[$hop->ip_noted] = theme('ecenter_weathermap_hop_option', $hop);
  }

  return drupal_get_form('ecenter_weathermap_select_form', $options);

  /*list($src_ip, $dst_ip) = array($_REQUEST['src_ip'], $_REQUEST['dst_ip']);
  if ($src_ip && $dst_ip) {
    $data = $client->getPathData($src_ip, $dst_ip, '2009-06-01 12:00:00', '2010-07-01 12:00:00');
    dpm($data);
  }

  if ($_REQUEST['ajax']) {
    // ...
  }*/
}

/**
 * Get the E-Center weather map client
 */
function ecenter_weathermap_get_client() {
  static $client = False;
  if (!$client) {
    require_once(dirname(__FILE__) . '/client.php');
    $host = variable_get('ecenter_weathermap_host', 'localhost');
    $port = variable_get('ecenter_weathermap_port', 8000);
    $dir = variable_get('ecenter_weathermap_basedir', '');
    $client = new Ecenter_Data_Service_Client($host, $port, $dir);
  }
  return $client;
}

/**
 * Sanitize the get array
 */
function ecenter_weathermap_sanitize_get() {
  if (!function_exists('filter_input')) {
    return $_GET;
  }
  $get = array();
  foreach (array_keys($_GET) as $key) {
    $get[$key] = filter_input(INPUT_GET, $key, FILTER_SANITIZE_STRING);
  }
  return $get;
}
