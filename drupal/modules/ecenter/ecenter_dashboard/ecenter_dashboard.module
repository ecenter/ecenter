<?php

include_once('ecenter_dashboard.features.inc');

/**
 * Implementation of hook_menu().
 */
function ecenter_dashboard_menu() {
  $items['ecenter-dashboard'] = array(
    'page callback' => 'theme',
    'page arguments' => array('ecenter_dashboard'),
    'title' => 'Dashboard',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implementation of hook_theme().
 */
function ecenter_dashboard_theme() {
  return array(
    'ecenter_dashboard' => array(
      'template' => 'ecenter-dashboard',
      'arguments' => array(),
    ),
  );
}

/**
 * E-Center dashboard callback
 */
function template_preprocess_ecenter_dashboard(&$vars) {
  global $user;

  drupal_add_js(libraries_get_path('raphael') .'/raphael-min.js');
  drupal_add_js(libraries_get_path('qtip') .'/jquery.qtip.js');
  drupal_add_js(drupal_get_path('module', 'ecenter_dashboard') .'/js/ecenter-dashboard.js');

  if ($user->uid) {
    // Calculate proper date range
    $data = ecenter_network_get_site_centric_data('LBL', '2011-06-24 00:00:00', '2011-06-25 00:00:00');
    drupal_add_js(array('ecenterNetwork' => array('siteData' => $data)), 'setting');

    $vars['main_content'] = array(
      'site_view' => array(
        'content' => '<p><strong>Warning:</strong> Site centric view currently uses a static query for June 24-25 from LBL for demonstration purposes.</p>',
      ),
      'activity' => array(
        'subject' => t('Site activity'),
        'description' => t('Activity on the site and in your groups'),
        'content' => views_embed_view('ecenter_dashboard_activity', 'block_personal'),
      ),
    );
    $vars['secondary_content'] = array(
      'tools' => array(
        'subject' => t('Tools'),
        'content' => theme('links', menu_navigation_links('menu-action-links')),
      ),
      'hot-comments' => array(
        'subject' => t('Hot conversations'),
        'description' => t('The most active public conversations in the past 2 weeks'),
        'content' => views_embed_view('ecenter_dashboard_hot_comments', 'block'),
      ),
      'hot-content' => array(
        'subject' => t('Most popular content'),
        'description' => t('The most popular content in the past month'),
        'content' => views_embed_view('ecenter_dashboard_hot_content', 'block'),
      ),
    );
  }
  else {
    $vars['main_content'] = array(
      'activity' => array(
        'subject' => t('Site activity'),
        'description' => t('All public activity'),
        'content' => views_embed_view('ecenter_dashboard_activity', 'block_public'),
      ),
    );
    $vars['secondary_content'] = array(
      'login' => module_invoke('user', 'block', 'view', 0),
      'hot-comments' => array(
        'subject' => t('Hot conversations'),
        'description' => t('The most active public conversations in the past 2 weeks'),
        'content' => views_embed_view('ecenter_dashboard_hot_comments', 'block_1'),
      ),
      'hot-content' => array(
        'subject' => t('Most popular content'),
        'description' => t('The most popular content in the past month'),
        'content' => views_embed_view('ecenter_dashboard_hot_content', 'block_1'),
      ),
    );
  }

}
